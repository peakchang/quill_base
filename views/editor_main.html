<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <!-- Include stylesheet -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Include the Quill library -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>



    <!-- Create the editor container -->
    <form action="update" method="post" id="mainform">
        <input type="text" name="test">
        <textarea name="quill_val" cols="60" rows="30" id="output-html"></textarea>
        <!-- <div class="ql-snow">
            <div class="ql-editor" id="output-html">
               // the content goes here
            </div>
         </div> -->

        <div id="editor">
            <p>Hello World!</p>
            <p>Some initial <strong>bold</strong> text</p>
            <p><br></p>
        </div>
        <div>
            <button>dkdkdkdkdk</button>
        </div>
    </form>

    <button class="testax">testBtn</button>



    <!-- Initialize Quill editor -->
    <script>

        const testax = document.querySelector('.testax');
        testax.addEventListener('click', (e) => {

            var testVal = {name: '창용', age: 38}
            axios.post(`/testax`, testVal)
                .then((res) => {
                    console.log(res.data);
                })
                .catch((err) => {
                    console.error(err);
                });

        })



        var toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
            ['blockquote', 'code-block'],

            [{ 'header': 1 }, { 'header': 2 }],               // custom button values
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'script': 'sub' }, { 'script': 'super' }],      // superscript/subscript
            [{ 'indent': '-1' }, { 'indent': '+1' }],          // outdent/indent
            [{ 'direction': 'rtl' }],                         // text direction
            [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
            // [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
            [{ 'font': [] }],
            [{ 'align': [] }],
            ['link', 'image'],
            ['clean']                                         // remove formatting button
        ];

        var quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: toolbarOptions
            }
        });


        testGlobal = ['slslslslslsl']

        quill.on('text-change', (delta, source) => {

            console.log(quill.root.innerHTML);
            var justHtml = quill.root.innerHTML;
            console.log(testGlobal);

            // console.log(justHtml);

            var getBase64 = chkBase64(justHtml)
            if (getBase64 != "") {
                var file = base64toFile(getBase64[0], 'image_file.png');
                var form_data = document.querySelector('#mainform')
                form_data.append("file", file);
                console.log(getBase64);
            }
            document.getElementById('output-html').innerHTML = justHtml;
        });


        function chkBase64(hihi) {
            let arr1 = hihi.split('img').map(v => v.includes('src') === true && v.split('src='));
            let arr2 = arr1.map(v => v && v[1]?.split("></p"));
            return arr2.map(v => v && v[0].slice(1, v[0]?.length - 1)).filter(v => v !== false);
        }

        function base64toFile(base_data, filename) {
            var arr = base_data.split(',');
            // var mime = arr[0].match(/:(.*?);/);
            // var bstr = Base64.decodeBase64(arr[1].getByte());

            var base64Data = {base64Data: arr[1]}
            axios.post(`/testax`, base64Data)
                .then((res) => {
                    console.log(res.data);
                    testGlobal.push('dididiidid')
                })
                .catch((err) => {
                    console.error(err);
                });
            console.log(arr[1]);
            //     bstr = atob(arr[1]),
            //     n = bstr.length,
            //     u8arr = new Uint8Array(n);
            // while (n--) {
            //     u8arr[n] = bstr.charCodeAt(n);
            // }

            // return new File([u8arr], filename, { type: mime });
        }




        // const searchSrc = (root) => {
        //     const arr1 = root.split('img').map(v => v.includes('src') === true && v.split("src="));
        //     const arr2 = arr1.map(v => v && v[1]?.split("></p"))
        //     return arr2.map(v => v && v[0].slice(1, v[0]?.length - 1)).filter(v => v !== false);
        // } // "data:image/png;base64~~~"

        // searchSrc(quillInstance?.current?.root?.innerHTML).map((v, i) => {
        //     if (v?.length > 1000) { //  "data:image/png;base64~~~"는 1000자를 넘어가기 때문에 + base64만 가져오기 위해서
        //         const imgBase64 = v;
        //         const file = DataURIToBlob(imgBase64);
        //     }
        // })

        // DataURIToBlob = (dataURI) => {
        //     const splitDataURI = dataURI.split(',')
        //     const byteString = splitDataURI[0].indexOf('base64') >= 0 ? atob(splitDataURI[1]) : decodeURI(splitDataURI[1])
        //     const mimeString = splitDataURI[0].split(':')[1].split(';')[0]
        //     const ia = new Uint8Array(byteString.length)
        //     for (let i = 0; i < byteString.length; i++)
        //         ia[i] = byteString.charCodeAt(i)

        //     return new Blob([ia], { type: mimeString })
        // } // 출처 stackoverflow
    </script>
</body>

</html>